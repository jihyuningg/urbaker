import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  doc, 
  updateDoc, 
  setDoc,
  deleteDoc,
  Timestamp
} from 'firebase/firestore';
import { 
  ShoppingBasket, 
  Plus, 
  User,
  Smartphone,
  Lock,
  CheckCircle2,
  ChevronRight,
  CalendarDays,
  X,
  Tag,
  AlertCircle
} from 'lucide-react';

/**
 * [환경변수 체크] 
 * Firebase 설정값이 없는 환경에서도 앱이 깨지지 않도록 방어 로직을 추가했습니다.
 */
let firebaseApp;
let auth;
let db;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'urbaker-official';

try {
  const firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config) 
    : { apiKey: "fallback" };
    
  firebaseApp = initializeApp(firebaseConfig);
  auth = getAuth(firebaseApp);
  db = getFirestore(firebaseApp);
} catch (e) {
  console.error("Firebase 초기화 에러:", e);
}

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('order'); 
  const [adminSubView, setAdminSubView] = useState('orders');
  const [loading, setLoading] = useState(true);
  const [submitted, setSubmitted] = useState(false);
  
  const [settings, setSettings] = useState({ 
    pickupDates: ['02/26 (목)', '02/27 (금)', '02/28 (토)'], 
    products: [
      { id: 'p1', name: '초코 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p2', name: '말차 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p3', name: '츄러스 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p4', name: '얼그레이 휘낭시에', originalPrice: 4000, price: 3500 }
    ] 
  });
  const [orders, setOrders] = useState([]);
  const [orderForm, setOrderForm] = useState({ name: '', phone: '', pickupDate: '', items: {} });

  // 1. Firebase 인증 및 상태 감시
  useEffect(() => {
    if (!auth) return;

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("인증 실패", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // 2. 실시간 데이터 수신
  useEffect(() => {
    if (!user || !db) return;

    const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
    const unsubSettings = onSnapshot(settingsRef, (snap) => {
      if (snap.exists()) {
        setSettings(snap.data());
      } else {
        // 클라우드에 데이터가 없으면 현재 로컬 기본값으로 생성
        setDoc(settingsRef, settings);
      }
    }, (err) => console.error("Settings load error:", err));

    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(ordersRef, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setOrders(data.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)));
      setLoading(false);
    }, (err) => {
      console.error("Orders load error:", err);
      setLoading(false);
    });

    return () => { unsubSettings(); unsubOrders(); };
  }, [user]);

  const handleOrderSubmit = async (e) => {
    e.preventDefault();
    if (!orderForm.name || !orderForm.pickupDate || Object.values(orderForm.items).every(q => q === 0)) {
      return;
    }
    
    try {
      const total = Object.entries(orderForm.items).reduce((sum, [id, qty]) => {
        const p = settings.products.find(x => x.id === id);
        return sum + (p ? p.price * qty : 0);
      }, 0);

      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        ...orderForm,
        totalPrice: total,
        status: 'pending',
        createdAt: Timestamp.now()
      });
      setSubmitted(true);
    } catch (err) {
      console.error(err);
    }
  };

  if (loading) return (
    <div className="min-h-screen bg-[#FDFBF9] flex flex-col items-center justify-center">
      <div className="w-10 h-10 border-4 border-[#6F3E1E]/20 border-t-[#6F3E1E] rounded-full animate-spin mb-4"></div>
      <div className="font-serif text-2xl italic font-black text-[#6F3E1E]">URBAKER</div>
    </div>
  );

  // 관리자 화면
  if (view === 'admin') {
    return (
      <div className="min-h-screen bg-stone-50 text-stone-900 font-sans pb-20 selection:bg-stone-200">
        <nav className="bg-white/80 backdrop-blur-md border-b px-6 py-4 flex flex-col gap-4 sticky top-0 z-50">
          <div className="flex justify-between items-center">
            <h1 className="font-serif text-xl font-black text-[#6F3E1E] italic">ADMIN PORTAL</h1>
            <button onClick={() => setView('order')} className="p-2 hover:bg-stone-100 rounded-full transition-colors"><X size={20}/></button>
          </div>
          <div className="flex bg-stone-100 p-1 rounded-2xl">
            <button onClick={() => setAdminSubView('orders')} className={`flex-1 py-2.5 text-xs font-black rounded-xl transition-all ${adminSubView === 'orders' ? 'bg-white shadow-md text-[#6F3E1E]' : 'text-stone-400 hover:text-stone-600'}`}>주문현황</button>
            <button onClick={() => setAdminSubView('settings')} className={`flex-1 py-2.5 text-xs font-black rounded-xl transition-all ${adminSubView === 'settings' ? 'bg-white shadow-md text-[#6F3E1E]' : 'text-stone-400 hover:text-stone-600'}`}>설정관리</button>
          </div>
        </nav>

        <div className="max-w-2xl mx-auto p-6 space-y-4">
          {adminSubView === 'orders' ? (
            orders.length === 0 ? (
              <div className="flex flex-col items-center justify-center py-32 text-stone-300">
                <AlertCircle size={48} strokeWidth={1} className="mb-4 opacity-20"/>
                <p className="font-medium">접수된 주문이 없습니다.</p>
              </div>
            ) : (
              orders.map(order => (
                <div key={order.id} className="bg-white rounded-[2rem] p-6 shadow-sm border border-stone-200 hover:border-stone-300 transition-colors">
                  <div className="flex justify-between items-start mb-4">
                    <div className="space-y-1">
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-black text-white bg-[#A88B73] px-2 py-0.5 rounded-full uppercase tracking-wider">{order.pickupDate}</span>
                        {order.status === 'paid' && <span className="text-[10px] font-black text-green-600 bg-green-50 px-2 py-0.5 rounded-full">결제확인됨</span>}
                      </div>
                      <h3 className="text-xl font-black text-stone-800">{order.name}</h3>
                      <p className="text-xs text-stone-400 font-medium tracking-tight">{order.phone}</p>
                    </div>
                    <button 
                      onClick={async () => {
                        const newStatus = order.status === 'paid' ? 'pending' : 'paid';
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id), { status: newStatus });
                      }}
                      className={`h-10 px-4 rounded-2xl text-xs font-black transition-all ${order.status === 'paid' ? 'bg-green-500 text-white shadow-lg shadow-green-100' : 'bg-stone-100 text-stone-400 hover:bg-stone-200'}`}
                    >
                      {order.status === 'paid' ? '완료' : '결제 대기'}
                    </button>
                  </div>
                  <div className="bg-stone-50 rounded-2xl p-5 space-y-2 text-sm">
                    {Object.entries(order.items || {}).map(([pid, qty]) => {
                      if(!qty) return null;
                      const p = settings.products.find(x => x.id === pid);
                      return (
                        <div key={pid} className="flex justify-between items-center text-stone-600">
                          <span className="font-medium">{p?.name}</span>
                          <span className="font-black text-stone-900">{qty}개</span>
                        </div>
                      );
                    })}
                    <div className="pt-3 mt-3 border-t border-stone-200 flex justify-between font-black text-[#6F3E1E] text-base">
                      <span>합계</span><span>{(order.totalPrice || 0).toLocaleString()}원</span>
                    </div>
                  </div>
                  <button onClick={async () => { if(confirm('데이터를 삭제할까요?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id)); }} className="w-full mt-4 text-[10px] font-bold text-stone-300 hover:text-red-400 transition-colors py-2">삭제</button>
                </div>
              ))
            )
          ) : (
            <div className="space-y-6">
              <div className="bg-white p-7 rounded-[2.5rem] border border-stone-200 shadow-sm">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="font-black text-lg text-stone-800">날짜 관리</h3>
                  <button onClick={() => {
                    const d = prompt('날짜 추가 (예: 03/01 (일))');
                    if(d) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {...settings, pickupDates: [...settings.pickupDates, d]});
                  }} className="w-10 h-10 bg-stone-100 hover:bg-[#6F3E1E] hover:text-white rounded-2xl flex items-center justify-center transition-all text-stone-600"><Plus size={20}/></button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {settings.pickupDates.map(d => (
                    <span key={d} className="pl-4 pr-3 py-2 bg-stone-50 border border-stone-100 rounded-xl text-xs flex items-center gap-3 font-bold text-stone-700">
                      {d} 
                      <X size={14} className="cursor-pointer text-stone-300 hover:text-red-500 transition-colors" onClick={() => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {...settings, pickupDates: settings.pickupDates.filter(x => x !== d)})}/>
                    </span>
                  ))}
                </div>
              </div>

              <div className="bg-white p-7 rounded-[2.5rem] border border-stone-200 shadow-sm">
                <div className="flex justify-between items-center mb-6">
                  <h3 className="font-black text-lg text-stone-800">제품 및 가격 관리</h3>
                  <button onClick={() => {
                    const name = prompt('제품명');
                    const originalPrice = prompt('정상가 (숫자만)');
                    const price = prompt('할인가 (숫자만)');
                    if(name && originalPrice && price) {
                      const newId = `p_${Date.now()}`;
                      setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {
                        ...settings, 
                        products: [...settings.products, { id: newId, name, originalPrice: parseInt(originalPrice), price: parseInt(price) }]
                      });
                    }
                  }} className="w-10 h-10 bg-stone-100 hover:bg-[#6F3E1E] hover:text-white rounded-2xl flex items-center justify-center transition-all text-stone-600"><Plus size={20}/></button>
                </div>
                <div className="space-y-3">
                  {settings.products.map(p => (
                    <div key={p.id} className="flex justify-between items-center p-5 bg-stone-50 rounded-2xl border border-stone-100">
                      <div>
                        <span className="text-sm font-black text-stone-800 block">{p.name}</span>
                        <div className="flex items-center gap-2 mt-1.5">
                          <span className="text-[10px] text-stone-300 line-through font-bold">{p.originalPrice?.toLocaleString()}원</span>
                          <span className="text-[12px] font-black text-[#6F3E1E]">{p.price?.toLocaleString()}원</span>
                        </div>
                      </div>
                      <button onClick={() => {
                        if(confirm('이 제품을 삭제할까요?')) {
                          setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {
                            ...settings,
                            products: settings.products.filter(x => x.id !== p.id)
                          });
                        }
                      }} className="p-2 text-stone-200 hover:text-red-500 transition-colors"><X size={18}/></button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 사용자 주문 화면
  return (
    <div className="min-h-screen bg-[#FDFBF9] text-[#2D1B10] font-sans pb-20 selection:bg-[#F3E6D8]">
      <header className="pt-16 pb-12 text-center animate-in fade-in zoom-in duration-1000">
        <h1 className="text-7xl font-serif font-black italic tracking-tighter text-[#6F3E1E] mb-2 drop-shadow-sm">URBAKER</h1>
        <p className="text-[10px] tracking-[0.5em] uppercase font-black text-[#A88B73] opacity-80">Artisan Financier Shop</p>
      </header>

      {!submitted ? (
        <div className="max-w-md mx-auto px-6 space-y-10 animate-in fade-in slide-in-from-bottom-6 duration-1000">
          <div className="text-center space-y-2">
            <h2 className="text-2xl font-black text-[#6F3E1E]">Financier Booking</h2>
            <p className="text-stone-400 text-xs font-bold uppercase tracking-wider">유어베이커 휘낭시에 주문 신청 화면입니다.</p>
          </div>

          <form onSubmit={handleOrderSubmit} className="space-y-8 pb-32">
            {/* 개인정보 입력부 */}
            <div className="bg-white rounded-[3rem] p-10 shadow-2xl shadow-[#6F3E1E]/5 border border-stone-100 space-y-7">
              <div className="space-y-5">
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-2"><User size={12}/> Customer Name</label>
                  <input required type="text" placeholder="성함을 입력해주세요" className="w-full h-16 px-6 bg-stone-50 rounded-2xl outline-none focus:ring-2 focus:ring-[#6F3E1E]/10 transition-all text-sm font-black placeholder:text-stone-300 border border-transparent focus:border-stone-100" value={orderForm.name} onChange={e => setOrderForm({...orderForm, name: e.target.value})} />
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-2"><Smartphone size={12}/> Phone Number</label>
                  <input required type="tel" placeholder="010-0000-0000" className="w-full h-16 px-6 bg-stone-50 rounded-2xl outline-none focus:ring-2 focus:ring-[#6F3E1E]/10 transition-all text-sm font-black placeholder:text-stone-300 border border-transparent focus:border-stone-100" value={orderForm.phone} onChange={e => setOrderForm({...orderForm, phone: e.target.value})} />
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-2"><CalendarDays size={12}/> Pickup Date</label>
                  <div className="relative">
                    <select required className="w-full h-16 px-6 bg-stone-50 rounded-2xl outline-none focus:ring-2 focus:ring-[#6F3E1E]/10 transition-all text-sm font-black appearance-none border border-transparent focus:border-stone-100" value={orderForm.pickupDate} onChange={e => setOrderForm({...orderForm, pickupDate: e.target.value})}>
                      <option value="">수령일 선택</option>
                      {settings.pickupDates.map(d => <option key={d} value={d}>{d}</option>)}
                    </select>
                    <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-stone-300">
                       <ChevronRight size={20} className="rotate-90" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* 메뉴 선택부 */}
            <div className="bg-white rounded-[3rem] p-10 shadow-2xl shadow-[#6F3E1E]/5 border border-stone-100">
              <h3 className="text-xs font-black text-[#A88B73] uppercase tracking-[0.2em] mb-10 flex items-center gap-2 px-1"><ShoppingBasket size={18}/> Menu Selection</h3>
              <div className="space-y-12">
                {settings.products.map(p => (
                  <div key={p.id} className="flex justify-between items-center group">
                    <div className="space-y-2">
                      <p className="font-black text-base text-stone-800 group-hover:text-[#6F3E1E] transition-colors">{p.name}</p>
                      <div className="flex items-center gap-3">
                        {p.originalPrice && (
                          <span className="text-[11px] text-stone-300 line-through font-bold tracking-tight">{p.originalPrice.toLocaleString()}원</span>
                        )}
                        <span className="text-sm font-black text-[#6F3E1E] flex items-center gap-1.5 bg-[#6F3E1E]/5 px-2 py-0.5 rounded-lg">
                          {p.price.toLocaleString()}원
                          <Tag size={12} className="text-[#A88B73]"/>
                        </span>
                      </div>
                    </div>
                    <div className="flex items-center gap-4 bg-stone-50 p-1.5 rounded-2xl border border-stone-100 shadow-inner">
                      <button type="button" onClick={() => {
                        const q = orderForm.items[p.id] || 0;
                        if(q > 0) setOrderForm({...orderForm, items: {...orderForm.items, [p.id]: q - 1}});
                      }} className="w-10 h-10 bg-white rounded-xl shadow-md flex items-center justify-center font-black text-[#6F3E1E] transition-all hover:bg-[#6F3E1E] hover:text-white active:scale-90">-</button>
                      <span className="w-6 text-center text-sm font-black text-stone-800">{orderForm.items[p.id] || 0}</span>
                      <button type="button" onClick={() => {
                        const q = orderForm.items[p.id] || 0;
                        setOrderForm({...orderForm, items: {...orderForm.items, [p.id]: q + 1}});
                      }} className="w-10 h-10 bg-white rounded-xl shadow-md flex items-center justify-center font-black text-[#6F3E1E] transition-all hover:bg-[#6F3E1E] hover:text-white active:scale-90">+</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* 고정 하단 버튼 영역 */}
            <div className="fixed bottom-0 left-0 right-0 bg-[#FDFBF9]/80 backdrop-blur-xl border-t border-stone-100 p-6 z-40">
              <div className="max-w-md mx-auto">
                <div className="bg-[#2D1B10] p-6 rounded-[2rem] shadow-2xl flex items-center justify-between gap-6">
                  <div className="flex flex-col">
                    <span className="text-[10px] font-black uppercase tracking-[0.1em] text-stone-400">Total Price</span>
                    <span className="text-xl font-black text-white">
                      {Object.entries(orderForm.items).reduce((s, [id, q]) => {
                        const p = settings.products.find(x => x.id === id);
                        return s + (p ? p.price * q : 0);
                      }, 0).toLocaleString()}원
                    </span>
                  </div>
                  <button type="submit" className="flex-1 h-16 bg-[#6F3E1E] text-white rounded-2xl font-black text-base hover:brightness-125 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-xl shadow-[#6F3E1E]/20">
                    예약 신청 <ChevronRight size={20}/>
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      ) : (
        <div className="max-w-md mx-auto px-6 animate-in zoom-in-95 duration-700">
          <div className="bg-white rounded-[4rem] p-16 text-center shadow-2xl border border-stone-100">
            <div className="w-24 h-24 bg-[#6F3E1E]/5 rounded-full flex items-center justify-center mx-auto mb-8 animate-bounce">
              <CheckCircle2 size={48} className="text-[#6F3E1E]"/>
            </div>
            <h2 className="text-3xl font-black mb-3 text-stone-800">Reservation Success!</h2>
            <p className="text-sm text-stone-400 font-bold leading-relaxed mb-10">
              {orderForm.name} 사장님, 예약이 정상 접수되었습니다.<br/>
              <span className="text-[#6F3E1E]">{orderForm.pickupDate}</span>에 뵙겠습니다.
            </p>
            <button onClick={() => { setSubmitted(false); setOrderForm({ name:'', phone:'', pickupDate:'', items:{} }); }} className="text-[#A88B73] font-black text-xs border-b-2 border-[#A88B73]/20 pb-1 hover:text-[#6F3E1E] hover:border-[#6F3E1E] transition-all">신규 예약 접수</button>
          </div>
        </div>
      )}

      <footer className="mt-20 text-center space-y-4 opacity-30 hover:opacity-100 transition-opacity">
        <button 
          onClick={() => { const p = prompt('Admin Password'); if(p === '9926') setView('admin'); }}
          className="text-[10px] font-black tracking-[0.3em] text-stone-400 flex items-center gap-2 mx-auto"
        >
          <Lock size={10}/> PRIVATE ACCESS
        </button>
      </footer>
    </div>
  );
}