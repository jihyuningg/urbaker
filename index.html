import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  doc, 
  updateDoc, 
  setDoc,
  deleteDoc,
  Timestamp,
  query,
  orderBy
} from 'firebase/firestore';
import { 
  ShoppingBasket, 
  Plus, 
  User,
  Smartphone,
  Lock,
  CheckCircle2,
  ChevronRight,
  CalendarDays,
  X,
  Tag,
  AlertCircle,
  Trash2
} from 'lucide-react';

/**
 * [Firebase 직접 설정] 
 * 사장님께서 주신 설정값을 코드에 직접 입력하여 연결 안정성을 확보했습니다.
 */
const firebaseConfig = {
  apiKey: "AIzaSyDSswqgDFO8yshyb14lan3JhnrAlZc_tyQ",
  authDomain: "urbaker-32276.firebaseapp.com",
  projectId: "urbaker-32276",
  storageBucket: "urbaker-32276.firebasestorage.app",
  messagingSenderId: "775330988751",
  appId: "1:775330988751:web:d7a32a3a4677592fb8adba",
  measurementId: "G-05KWZGQWRW"
};

// 앱 초기화
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "urbaker-official";

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('order'); 
  const [adminSubView, setAdminSubView] = useState('orders');
  const [loading, setLoading] = useState(true);
  const [submitted, setSubmitted] = useState(false);
  
  // 기본 데이터 설정 (DB 연결 전 초기값)
  const [settings, setSettings] = useState({ 
    pickupDates: ['02/26 (목)', '02/27 (금)', '02/28 (토)'], 
    products: [
      { id: 'p1', name: '초코 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p2', name: '말차 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p3', name: '츄러스 휘낭시에', originalPrice: 4000, price: 3500 },
      { id: 'p4', name: '얼그레이 휘낭시에', originalPrice: 4000, price: 3500 }
    ] 
  });
  const [orders, setOrders] = useState([]);
  const [orderForm, setOrderForm] = useState({ name: '', phone: '', pickupDate: '', items: {} });

  // 인증 처리
  useEffect(() => {
    signInAnonymously(auth).catch(err => console.error("익명 로그인 실패:", err));
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 실시간 데이터 동기화
  useEffect(() => {
    if (!user) return;

    // 설정값 로드
    const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
    const unsubSettings = onSnapshot(settingsRef, (snap) => {
      if (snap.exists()) {
        setSettings(snap.data());
      } else {
        setDoc(settingsRef, settings);
      }
    });

    // 주문 목록 로드 (관리자용)
    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    const unsubOrders = onSnapshot(ordersRef, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // 클라이언트 단에서 정렬 (최신순)
      setOrders(data.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)));
    });

    return () => { unsubSettings(); unsubOrders(); };
  }, [user]);

  const handleOrderSubmit = async (e) => {
    e.preventDefault();
    if (!orderForm.name || !orderForm.pickupDate || Object.values(orderForm.items).every(q => q === 0)) {
      return;
    }
    
    try {
      const total = Object.entries(orderForm.items).reduce((sum, [id, qty]) => {
        const p = settings.products.find(x => x.id === id);
        return sum + (p ? p.price * qty : 0);
      }, 0);

      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
        ...orderForm,
        totalPrice: total,
        status: 'pending',
        createdAt: Timestamp.now()
      });
      setSubmitted(true);
      window.scrollTo(0,0);
    } catch (err) {
      console.error("주문 실패:", err);
    }
  };

  if (loading) return (
    <div className="min-h-screen bg-[#FDFBF9] flex flex-col items-center justify-center">
      <div className="w-10 h-10 border-4 border-[#6F3E1E]/20 border-t-[#6F3E1E] rounded-full animate-spin mb-4"></div>
      <div className="font-serif text-2xl italic font-black text-[#6F3E1E]">URBAKER</div>
    </div>
  );

  // 관리자 모드
  if (view === 'admin') {
    return (
      <div className="min-h-screen bg-stone-50 text-stone-900 font-sans pb-20">
        <nav className="bg-white border-b px-6 py-4 flex flex-col gap-4 sticky top-0 z-50 shadow-sm">
          <div className="flex justify-between items-center">
            <h1 className="font-serif text-xl font-black text-[#6F3E1E] italic uppercase">Admin Portal</h1>
            <button onClick={() => setView('order')} className="p-2 hover:bg-stone-100 rounded-full"><X size={20}/></button>
          </div>
          <div className="flex bg-stone-100 p-1 rounded-2xl">
            <button onClick={() => setAdminSubView('orders')} className={`flex-1 py-2.5 text-xs font-black rounded-xl transition-all ${adminSubView === 'orders' ? 'bg-white shadow-sm text-[#6F3E1E]' : 'text-stone-400'}`}>주문현황</button>
            <button onClick={() => setAdminSubView('settings')} className={`flex-1 py-2.5 text-xs font-black rounded-xl transition-all ${adminSubView === 'settings' ? 'bg-white shadow-sm text-[#6F3E1E]' : 'text-stone-400'}`}>상품설정</button>
          </div>
        </nav>

        <div className="max-w-2xl mx-auto p-6 space-y-4">
          {adminSubView === 'orders' ? (
            orders.length === 0 ? (
              <div className="text-center py-20 text-stone-300 font-bold">접수된 주문이 없습니다.</div>
            ) : (
              orders.map(order => (
                <div key={order.id} className="bg-white rounded-[2rem] p-6 shadow-sm border border-stone-200">
                  <div className="flex justify-between items-start mb-4">
                    <div className="space-y-1">
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-black text-white bg-[#A88B73] px-2 py-0.5 rounded-full">{order.pickupDate}</span>
                        {order.status === 'paid' && <span className="text-[10px] font-black text-green-600 bg-green-50 px-2 py-0.5 rounded-full">결제완료</span>}
                      </div>
                      <h3 className="text-xl font-black">{order.name}</h3>
                      <p className="text-xs text-stone-400 font-bold">{order.phone}</p>
                    </div>
                    <button 
                      onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id), { status: order.status === 'paid' ? 'pending' : 'paid' })}
                      className={`h-10 px-4 rounded-2xl text-xs font-black transition-all ${order.status === 'paid' ? 'bg-green-500 text-white shadow-lg shadow-green-100' : 'bg-stone-100 text-stone-400'}`}
                    >
                      {order.status === 'paid' ? '완료됨' : '입금대기'}
                    </button>
                  </div>
                  <div className="bg-stone-50 rounded-2xl p-4 space-y-2 text-sm">
                    {Object.entries(order.items || {}).map(([pid, qty]) => {
                      if(!qty) return null;
                      const p = settings.products.find(x => x.id === pid);
                      return (
                        <div key={pid} className="flex justify-between items-center text-stone-600">
                          <span>{p?.name}</span>
                          <span className="font-black text-stone-900">{qty}개</span>
                        </div>
                      );
                    })}
                    <div className="pt-3 mt-3 border-t border-stone-200 flex justify-between font-black text-[#6F3E1E] text-base">
                      <span>합계</span><span>{(order.totalPrice || 0).toLocaleString()}원</span>
                    </div>
                  </div>
                  <button onClick={() => { if(confirm('주문을 삭제할까요?')) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id)); }} className="w-full mt-4 text-[10px] font-bold text-stone-300 hover:text-red-400 py-2">주문 삭제</button>
                </div>
              ))
            )
          ) : (
            <div className="space-y-6">
              {/* 날짜 설정 */}
              <div className="bg-white p-7 rounded-[2.5rem] border border-stone-200 shadow-sm">
                <div className="flex justify-between items-center mb-6 px-1">
                  <h3 className="font-black text-lg">수령 가능 날짜</h3>
                  <button onClick={() => {
                    const d = prompt('추가할 날짜 (예: 03/01 (일))');
                    if(d) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {...settings, pickupDates: [...settings.pickupDates, d]});
                  }} className="w-10 h-10 bg-stone-100 hover:bg-[#6F3E1E] hover:text-white rounded-2xl flex items-center justify-center transition-all"><Plus size={20}/></button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {settings.pickupDates.map(d => (
                    <span key={d} className="pl-4 pr-3 py-2 bg-stone-50 border border-stone-100 rounded-xl text-xs flex items-center gap-3 font-bold">
                      {d} 
                      <X size={14} className="cursor-pointer text-stone-300 hover:text-red-500" onClick={() => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {...settings, pickupDates: settings.pickupDates.filter(x => x !== d)})}/>
                    </span>
                  ))}
                </div>
              </div>
              {/* 상품 설정 */}
              <div className="bg-white p-7 rounded-[2.5rem] border border-stone-200 shadow-sm">
                <div className="flex justify-between items-center mb-6 px-1">
                  <h3 className="font-black text-lg">메뉴 관리</h3>
                  <button onClick={() => {
                    const name = prompt('제품명');
                    const originalPrice = prompt('정상가 (숫자만)');
                    const price = prompt('할인가 (숫자만)');
                    if(name && originalPrice && price) {
                      setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {
                        ...settings, 
                        products: [...settings.products, { id: `p_${Date.now()}`, name, originalPrice: parseInt(originalPrice), price: parseInt(price) }]
                      });
                    }
                  }} className="w-10 h-10 bg-stone-100 hover:bg-[#6F3E1E] hover:text-white rounded-2xl flex items-center justify-center transition-all"><Plus size={20}/></button>
                </div>
                <div className="space-y-3">
                  {settings.products.map(p => (
                    <div key={p.id} className="flex justify-between items-center p-5 bg-stone-50 rounded-2xl border border-stone-100">
                      <div>
                        <span className="text-sm font-black text-stone-800 block">{p.name}</span>
                        <div className="flex items-center gap-2 mt-1">
                          <span className="text-[10px] text-stone-300 line-through font-bold">{p.originalPrice?.toLocaleString()}원</span>
                          <span className="text-xs font-black text-[#6F3E1E]">{p.price?.toLocaleString()}원</span>
                        </div>
                      </div>
                      <button onClick={() => { if(confirm('삭제할까요?')) setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), {...settings, products: settings.products.filter(x => x.id !== p.id)}); }} className="p-2 text-stone-200 hover:text-red-500"><Trash2 size={18}/></button>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 주문 신청 화면
  return (
    <div className="min-h-screen bg-[#FDFBF9] text-[#2D1B10] font-sans pb-32">
      <header className="pt-20 pb-12 text-center">
        <h1 className="text-7xl font-serif font-black italic tracking-tighter text-[#6F3E1E] mb-2">URBAKER</h1>
        <p className="text-[10px] tracking-[0.5em] uppercase font-black text-[#A88B73] opacity-60">Artisan Financier Shop</p>
      </header>

      {!submitted ? (
        <div className="max-w-md mx-auto px-6 space-y-10">
          <div className="text-center space-y-2">
            <h2 className="text-2xl font-black text-[#6F3E1E]">Financier Booking</h2>
            <p className="text-stone-400 text-[11px] font-bold uppercase tracking-wider">유어베이커 휘낭시에 예약 시스템</p>
          </div>

          <form onSubmit={handleOrderSubmit} className="space-y-8">
            {/* 정보 입력 */}
            <div className="bg-white rounded-[3rem] p-10 shadow-2xl shadow-[#6F3E1E]/5 border border-stone-100 space-y-6">
              <div className="space-y-2">
                <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-1"><User size={12}/> Name</label>
                <input required type="text" placeholder="성함" className="w-full h-14 px-5 bg-stone-50 rounded-2xl font-black text-sm outline-none border-2 border-transparent focus:border-[#6F3E1E]/10 transition-all" value={orderForm.name} onChange={e => setOrderForm({...orderForm, name: e.target.value})} />
              </div>
              <div className="space-y-2">
                <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-1"><Smartphone size={12}/> Phone</label>
                <input required type="tel" placeholder="연락처" className="w-full h-14 px-5 bg-stone-50 rounded-2xl font-black text-sm outline-none border-2 border-transparent focus:border-[#6F3E1E]/10 transition-all" value={orderForm.phone} onChange={e => setOrderForm({...orderForm, phone: e.target.value})} />
              </div>
              <div className="space-y-2">
                <label className="text-[10px] font-black text-[#A88B73] uppercase tracking-[0.2em] flex items-center gap-2 ml-1"><CalendarDays size={12}/> Date</label>
                <select required className="w-full h-14 px-5 bg-stone-50 rounded-2xl font-black text-sm outline-none border-2 border-transparent focus:border-[#6F3E1E]/10 transition-all appearance-none" value={orderForm.pickupDate} onChange={e => setOrderForm({...orderForm, pickupDate: e.target.value})}>
                  <option value="">수령일 선택</option>
                  {settings.pickupDates.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
              </div>
            </div>

            {/* 메뉴 선택 */}
            <div className="bg-white rounded-[3rem] p-10 shadow-2xl shadow-[#6F3E1E]/5 border border-stone-100">
              <h3 className="text-xs font-black text-[#A88B73] uppercase tracking-[0.2em] mb-10 flex items-center gap-2"><ShoppingBasket size={18}/> Menu List</h3>
              <div className="space-y-10">
                {settings.products.map(p => (
                  <div key={p.id} className="flex justify-between items-center group">
                    <div className="space-y-1">
                      <p className="font-black text-base text-stone-800">{p.name}</p>
                      <div className="flex items-center gap-2">
                        {p.originalPrice && <span className="text-[10px] text-stone-300 line-through font-bold">{p.originalPrice.toLocaleString()}원</span>}
                        <span className="text-sm font-black text-[#6F3E1E] bg-[#6F3E1E]/5 px-2 py-0.5 rounded-lg flex items-center gap-1">
                          {p.price.toLocaleString()}원 <Tag size={10}/>
                        </span>
                      </div>
                    </div>
                    <div className="flex items-center gap-3 bg-stone-50 p-1 rounded-xl border border-stone-100">
                      <button type="button" onClick={() => {
                        const q = orderForm.items[p.id] || 0;
                        if(q > 0) setOrderForm({...orderForm, items: {...orderForm.items, [p.id]: q - 1}});
                      }} className="w-8 h-8 bg-white rounded-lg shadow-sm flex items-center justify-center font-black text-[#6F3E1E]">-</button>
                      <span className="w-4 text-center text-xs font-black">{orderForm.items[p.id] || 0}</span>
                      <button type="button" onClick={() => {
                        const q = orderForm.items[p.id] || 0;
                        setOrderForm({...orderForm, items: {...orderForm.items, [p.id]: q + 1}});
                      }} className="w-8 h-8 bg-white rounded-lg shadow-sm flex items-center justify-center font-black text-[#6F3E1E]">+</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* 하단 총합 및 제출 */}
            <div className="fixed bottom-0 left-0 right-0 bg-[#FDFBF9]/90 backdrop-blur-xl border-t border-stone-100 p-6 z-40">
              <div className="max-w-md mx-auto flex items-center justify-between gap-4 bg-[#2D1B10] p-5 rounded-[2rem] shadow-2xl">
                <div className="flex flex-col pl-2">
                  <span className="text-[10px] font-black uppercase tracking-wider text-stone-400">Total Price</span>
                  <span className="text-xl font-black text-white">
                    {Object.entries(orderForm.items).reduce((s, [id, q]) => {
                      const p = settings.products.find(x => x.id === id);
                      return s + (p ? p.price * q : 0);
                    }, 0).toLocaleString()}원
                  </span>
                </div>
                <button type="submit" className="flex-1 h-14 bg-[#6F3E1E] text-white rounded-2xl font-black text-sm hover:brightness-110 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                  예약 완료 <ChevronRight size={18}/>
                </button>
              </div>
            </div>
          </form>
        </div>
      ) : (
        <div className="max-w-md mx-auto px-6 py-10">
          <div className="bg-white rounded-[4rem] p-16 text-center shadow-2xl border border-stone-100">
            <div className="w-20 h-20 bg-[#6F3E1E]/5 rounded-full flex items-center justify-center mx-auto mb-8">
              <CheckCircle2 size={40} className="text-[#6F3E1E]"/>
            </div>
            <h2 className="text-2xl font-black mb-3 text-stone-800 tracking-tight">Reservation Success!</h2>
            <p className="text-sm text-stone-400 font-bold leading-relaxed mb-10">
              {orderForm.name}님, 예약이 정상 접수되었습니다.<br/>
              곧 확인 안내 문자를 보내드릴게요.
            </p>
            <button onClick={() => { setSubmitted(false); setOrderForm({ name:'', phone:'', pickupDate:'', items:{} }); }} className="text-[#A88B73] font-black text-xs border-b border-[#A88B73]/20 pb-0.5">신규 예약</button>
          </div>
        </div>
      )}

      <footer className="mt-20 pb-20 text-center opacity-20 hover:opacity-100 transition-opacity">
        <button 
          onClick={() => { if(prompt('Admin Password') === '9926') setView('admin'); }}
          className="text-[9px] font-black tracking-[0.4em] text-stone-400 flex items-center gap-2 mx-auto justify-center"
        >
          <Lock size={10}/> PRIVATE ACCESS
        </button>
      </footer>
    </div>
  );
}